<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Trip Responses</title>
    <!-- Re-using the same style.css from public for simplicity.
         Note the path starts with '/' because our server serves 'public' at the root. -->
    <link rel="stylesheet" href="/style.css">
</head>
<body>
    <div class="container responses-container"> <!-- Added 'responses-container' for potentially wider table -->
        <h1>Trip Availability Responses</h1>
        <button id="refreshButton">Refresh Data</button>
        <div id="responsesTableContainer">
            <p>Loading responses...</p> <!-- Initial message -->
        </div>
    </div>

    <script>
        // Wait for the HTML document to be fully loaded
        document.addEventListener('DOMContentLoaded', function() {
            const responsesContainer = document.getElementById('responsesTableContainer');
            const refreshButton = document.getElementById('refreshButton');

            // Function to fetch responses from the API and display them
            async function fetchAndDisplayResponses() {
                responsesContainer.innerHTML = '<p>Loading responses...</p>'; // Show loading message
                try {
                    // Fetch data from our backend API endpoint
                    const response = await fetch('/api/responses');
                    if (!response.ok) { // Check for network errors or server errors
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const responses = await response.json(); // Parse the JSON response

                    if (responses.length === 0) {
                        responsesContainer.innerHTML = '<p>No responses submitted yet.</p>';
                        return;
                    }

                    // Start building the HTML for the table
                    let tableHTML = `
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>Selected Dates</th>
                                    <th>Submitted At</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                    `;

                    // Loop through each response and create a table row
                    responses.forEach(r => {
                        // The 'selected_dates' from the DB is a comma-separated string.
                        // We'll split it and format each date nicely.
                        const formattedDates = r.selected_dates.split(',')
                            .map(dateStr => {
                                // Ensure correct parsing: Add 'T00:00:00' to treat as local date,
                                // otherwise new Date() can be inconsistent with just 'YYYY-MM-DD'.
                                const d = new Date(dateStr + 'T00:00:00Z'); // Treat as UTC, then format to local
                                return d.toLocaleDateString(undefined, { // 'undefined' uses user's locale
                                    weekday: 'short',
                                    year: 'numeric',
                                    month: 'short',
                                    day: 'numeric'
                                });
                            })
                            .join('<br>'); // Display each date on a new line within the cell

                        tableHTML += `
                            <tr>
                                <td>${r.id}</td>
                                <td>${r.name}</td>
                                <td>${formattedDates}</td>
                                <td>${r.submitted_at}</td>
                                <<td>
                                     <button class="delete-btn" data-id="${r.id}">Delete</button>
                                 </td>
                            </tr>
                        `;
                    });

                    tableHTML += `</tbody></table>`; // Close the table tags
                    responsesContainer.innerHTML = tableHTML; // Insert the generated table into the div

                } catch (error) {
                    console.error('Error fetching responses:', error);
                    responsesContainer.innerHTML = '<p>Error loading responses. Check the console for details.</p>';
                }
            }

            // Add event listener to the refresh button
            refreshButton.addEventListener('click', fetchAndDisplayResponses);
              // VVVV PASTE THE NEW JAVASCRIPT LOGIC HERE VVVV
             // Function to handle deleting a response
             async function deleteResponse(responseId) {
                 if (!confirm(`Are you sure you want to delete response ID ${responseId}?`)) {
                     return; // User cancelled the deletion
                 }

                 try {
                     const response = await fetch(`/api/responses/${responseId}`, {
                         method: 'DELETE',
                     });
                     const result = await response.json();

                     if (response.ok) {
                         alert(result.message); // Show success message
                         fetchAndDisplayResponses(); // Refresh the table
                     } else {
                         alert(result.message || 'Failed to delete response.');
                     }
                 } catch (error) {
                     console.error('Error deleting response:', error);
                     alert('An error occurred while trying to delete the response.');
                 }
             }

             // Add event listener for delete buttons (using event delegation)
             responsesContainer.addEventListener('click', function(event) {
                 if (event.target.classList.contains('delete-btn')) {
                     const responseId = event.target.dataset.id;
                     deleteResponse(responseId);
                 }
             });
             // ^^^^ END OF PASTED JAVASCRIPT LOGIC ^^^^

            // Load data immediately when the page loads
            fetchAndDisplayResponses();
        });
    </script>
</body>
</html>